---
title: "STI Report"
author: ""
date: "Report date: `r format(Sys.Date(), '%d %b %Y')`"
output: html_document
knit: (function(input, ...) {
  rmarkdown::render(input, output_file = paste0("STI Report", "-", format(Sys.Date(), "%d %b %Y")), output_dir = "../Output") })
---


```{r setup, include=FALSE}

con <- DBI::dbConnect(odbc::odbc(), "PHAR proxy")

knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, fig.height=6, fig.width=13, connection="con")

here::i_am("Report-Code.Rmd")

library(tidyverse)
library(janitor)
library(lubridate)
library(flextable)

```


```{r extract_data}
sti_raw <- DBI::dbGetQuery(con, 
                           "
                           SELECT * 
                           FROM dh_public_health.phess_release.caseevents ce 
                           LEFT JOIN dh_public_health.phess_release.events_bbvsti ev ON ce.EVENT_ID = ev.EVENT_ID 
                           WHERE CONDITION_TYPE = 'Sexually Transmissible Infections' 
                           AND EVENT_DATE BETWEEN '2022-01-01' AND '2025-06-30' 
                           ORDER BY EVENT_DATE DESC; 
                           "
                           )


```


```{r set params}
start_date <- ymd("2022-01-01")
max_date <- ymd("2025-06-30")
min_date_1yr <- max_date - years(1) + days(1)

```


```{r load pop_table}
pop_table <- readxl::read_xlsx(here::here("Data", "LGAPopulationData.xlsx")) %>% 
  rename(lga=LGA, 
         pop_2021 = Pop_2021)
```


``` {r gen_functions}
percent <- function (x) {round(x*100, digits=0)}

integer_breaks <- function(n = 5, ...) {
    fxn <- function(x) {
        breaks <- floor(pretty(x, n, ...))
        names(breaks) <- attr(breaks, "labels")
        breaks
    }
    return(fxn)
}

main_sti <- c("Chlamydia trachomatis infection", "Gonococcal infection", "Syphilis - Infectious", "Syphilis - Late")


# epimonth_breaks <- c(seq.Date(from=min(sti_data$mth_yr_fmt), to=max(sti_data$mth_yr_fmt) + months(1), by="month"))

```


```{r data clean}
agecat5_levels <- c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85+")

nephu_lgas <- c("Banyule (C)", "Boroondara (C)", "Darebin (C)", "Hume (C)", "Knox (C)", "Manningham (C)", "Maroondah (C)", "Nillumbik (S)", 
                    "Whitehorse (C)", "Whittlesea (C)", "Yarra (C)", "Yarra Ranges (S)")

sti_data <- sti_raw %>% 
  clean_names() %>% 
  remove_empty("cols") %>% 
  rename(defn = event_classification, 
         death = died_from_disease, 
         onset_date = calculated_date_of_onset, 
         age = age_years, 
         atsi = indigenous_status, 
         cob = country_of_birth) %>% 
  select(event_id, condition, event_date, event_type, defn, death, death_date, onset_date, 
         city, postcode, lga, lphu, age, age_months, sex, atsi, cob, assigned_lphu, 
         meets_investigation_criteria, investigation_status, case_found_by, sexual_orientation, infection_acquired) %>% 
  filter(defn=="Confirmed" | defn=="Probable") %>% 
  filter(event_type=="Case") %>% 
  remove_empty(which="cols") %>% 
  mutate(age = if_else(age==999, NA, age)) %>% 
  mutate(agecat5 = case_when(between(age, 0, 4) ~ "0-4", 
                             between(age, 5, 9) ~ "5-9",
                             between(age, 10, 14) ~ "10-14",
                             between(age, 15, 19) ~ "15-19",
                             between(age, 20, 24) ~ "20-24",
                             between(age, 25, 29) ~ "25-29",
                             between(age, 30, 34) ~ "30-34",
                             between(age, 35, 39) ~ "35-39",
                             between(age, 40, 44) ~ "40-44",
                             between(age, 45, 49) ~ "45-49",
                             between(age, 50, 54) ~ "50-54",
                             between(age, 55, 59) ~ "55-59",
                             between(age, 60, 64) ~ "60-64",
                             between(age, 65, 69) ~ "65-69",
                             between(age, 70, 74) ~ "70-74",
                             between(age, 75, 79) ~ "75-79",
                             between(age, 80, 84) ~ "80-84",
                             between(age, 85, 99) ~ "85+", 
                             TRUE ~ NA_character_), 
         agecat5 = factor(agecat5, levels=agecat5_levels), 
         aus_born = case_when(cob=="Australia" ~ "Australia", 
                              cob=="Australia (includes External Territories), nfd" ~ "Australia", 
                              cob=="Australia External Territories, nec" ~ "Australia", 
                              cob=="Not Stated" ~ "Unknown", 
                              cob=="Unknown" ~ "Unknown", 
                              TRUE ~ "Overseas"), 
         aus_born = factor(aus_born, levels=c("Australia", "Overseas", "Unknown")), 
         defn = factor(defn, levels=c("Confirmed", "Probable")), 
         sex = factor(sex, levels=c("Female", "Male", "Not stated", "Other")), 
         atsi = fct_collapse(factor(atsi, levels=c("Aboriginal and Torres Strait Islander origin", "Aboriginal but not Torres Strait Islander origin", "Torres Strait Islander but not Aboriginal origin",  "Not Aboriginal or Torres Strait Islander", "Missing/Not Stated", "Declined to answer")), `Aboriginal and/or Torres Strait Islander` = c("Aboriginal and Torres Strait Islander origin", "Aboriginal but not Torres Strait Islander origin", "Torres Strait Islander but not Aboriginal origin")), 
         cond = case_when(condition=="Chlamydia trachomatis infection" ~ "Chlamydia", 
                          condition=="Gonococcal infection" ~ "Gonorrhea", 
                          condition=="Human Immunodeficiency Virus Infection - Child aged less than 18 months" ~ "HIV - <18mths", 
                          condition=="Human Immunodeficiency Virus Infection - Individual aged 18 months or older" ~ "HIV - >=18mths", 
                          condition=="Human Immunodeficiency Virus Infection - Not further specified" ~ "HIV - nfs", 
                          TRUE ~ condition), 
         disease = case_when(condition=="Chlamydia trachomatis infection" ~ "Chlamydia", 
                          condition=="Gonococcal infection" ~ "Gonorrhea", 
                          condition=="Human Immunodeficiency Virus Infection - Child aged less than 18 months" ~ "HIV - <18mths", 
                          condition=="Human Immunodeficiency Virus Infection - Individual aged 18 months or older" ~ "HIV", 
                          condition=="Human Immunodeficiency Virus Infection - Not further specified" ~ "HIV", 
                          condition=="Syphilis - Infectious" ~ "Syphilis", 
                          condition=="Syphilis - Late" ~ "Syphilis", 
                          TRUE ~ condition), 
         event_date = ymd(event_date), 
         epiweek = epiweek(event_date), 
         epimonth = month(event_date, label=TRUE), 
         epiyear = epiyear(event_date), 
         epi_MY = my(paste(epimonth, epiyear, sep="-")), 
         epi_Y = ymd(paste0(epiyear, "-01-01")), 
         epi_WY = ceiling_date(event_date, "week") -1, 
         yr = year(event_date), 
         mth_yr_fmt = my(paste(month(event_date, label=TRUE), year(event_date))), 
         mth_yr = paste(epimonth, year(event_date))) %>% 
  arrange(event_date)


nephu_data <- filter(sti_data, lga %in% nephu_lgas)
  
```


### Disease Profiles

The diseases covered in this report are chlamydia, gonorrhea, syphilis and HIV.

Each disease profile will include:

* Age and sex distribution of cases

* Disease trends - 1 Jan 2022 to `r format(max_date, "%d %b %Y")` (NEPHU and by LGA vs VIC)

* Map showing annual rate per 100,000 population at LGA level (data in the last 12 months)

* Sexual exposure risk for Gonorrhea and Syphilis (NEPHU and by LGA)


```{r minors}
minor <- sti_data %>% 
  filter(age<16) %>% 
  filter(lga %in% nephu_lgas)


f.minor_dftable <- function(std) {
  table <- minor %>% 
    filter(disease==std) %>% 
    filter(event_date>=min_date_1yr) %>% 
    group_by(lga) %>% 
    summarise(total = n(), 
              females = sum(sex=="Female", na.rm=T), 
              pct_females = percent(females / total), 
              median_age = median(age, na.rm=T))
  return(table)
}

f.minor_table <- function(df) {
  flextable(df) %>% 
    autofit() %>% 
    set_header_labels(lga = "LGA", total = "Total", females = "Females", pct_females = "% Females", median_age = "Median age") %>% 
    set_caption("Data shown for the last 12 months")

}

#f.minor_table(f.minor_dftable("Gonorrhea"))

```


``` {r age-sex pyramid_function}
f.agesex_pyr_nephu <- function(std) {
  pyramid.dat <- sti_data %>% 
    filter(disease==std) %>% 
    filter(lga %in% nephu_lgas) %>% 
    select(age, agecat5, sex, defn, cond, condition, disease) %>% 
    filter(sex %in% c("Male", "Female")) %>% 
    mutate(sex=fct_rev(fct_drop(sex)))
  
  plot <- apyramid::age_pyramid(data=pyramid.dat, age_group="agecat5", split_by="sex", stack_by="disease", proportional=TRUE, show_midpoint=FALSE, pal=c("#F8766D", "#00BFC4")) + 
  cowplot::theme_cowplot() + 
  theme(plot.title = element_text(size=12), 
        legend.position="none") + 
  labs(y="cases", 
       x="age group (years)", 
       title=paste0("Age and sex distribution of\n", std, " cases in NEPHU"), 
       caption=paste0("Data period: ", start_date, " to ", max_date))
  
  return(plot)
}

#f.agesex_pyr_nephu("Chlamydia")


```

```{r vic rates}

sti_vic_mth_count <- sti_data %>% 
  #filter(condition %in% main_sti) %>% 
  group_by(mth_yr_fmt, disease) %>% 
  summarise(count = n(), cond = first(cond)) %>% 
  mutate(lga = "VIC")

sti_vic_mth_rate <- sti_vic_mth_count %>% 
  left_join(., pop_table, by="lga") %>% 
  mutate(mth_rate = count/pop_2021*100000)

```

``` {r nephu base map}
library(sf)

load(file.path(str_extract(getwd(), "^.+Epidemiology"), "Population Health Data/NEPHU Maps", "NEPHU_basemaps_sf.RData"))

```

``` {r map_function}
nudge_lga <- c("Boroondara", "Darebin", "Yarra", "Maroondah")

f.rate_map_lga <- function(std) {
  data <- sti_data %>% 
    filter(disease==std) %>% 
    filter(lga %in% nephu_lgas) %>% 
    filter(event_date>=min_date_1yr) %>% 
    group_by(lga) %>% 
    summarise(count=n()) %>% 
    left_join(., pop_table, by="lga") %>% 
    mutate(rate = count/pop_2021*100000)
  
  map <- left_join(nephu_lga.sf, data, by=c("lga_name_long"="lga")) %>% 
    ggplot() + 
    geom_sf(aes(fill=rate), col="black") + 
    scale_fill_gradient2(low="yellow", high="red", name = "Rate") + 
    geom_sf_text(data=nephu_lga.sf %>% filter(!(lga_name %in% nudge_lga)), aes(label=lga_name), size=3) + 
    geom_sf_text(data=nephu_lga.sf %>% filter(lga_name=="Darebin"), aes(label=lga_name), size=3, nudge_x = -0.07, nudge_y= -0.01) + 
    geom_sf_text(data=nephu_lga.sf %>% filter(lga_name=="Yarra"), aes(label=lga_name), size=3, nudge_x = -0.03, nudge_y= -0.01) + 
    geom_sf_text(data=nephu_lga.sf %>% filter(lga_name=="Boroondara"), aes(label=lga_name), size=3, nudge_x = -0.07, nudge_y= -0.025) + 
    geom_sf_text(data=nephu_lga.sf %>% filter(lga_name=="Maroondah"), aes(label=lga_name), size=3, nudge_x = 0.03, nudge_y= -0.01) + 
    theme_void() + 
    labs(title = paste0("Map showing LGA distribution of ", std, " case rate in last 12 months"), 
         subtitle="Annual rate per 100,000 population") + 
    theme(plot.title = element_text(size=12), 
          plot.subtitle = element_text(size=11))
  
  return(map)
  
}

#f.rate_map_lga("Gonorrhea")

```


``` {r nephu function}
# Create function for plotting disease trends graphs (NEPHU level)

f.trend_plot_nephu <- function(std) {
  nephu_mth_count <- sti_data %>% 
    filter(disease==std) %>% 
    filter(lga %in% nephu_lgas) %>% 
    group_by(mth_yr_fmt) %>% 
    summarise(count=n(), cond=first(cond), disease=first(disease)) %>% 
    mutate(lga="NEPHU")
  
  nephu_mth_rate <- left_join(nephu_mth_count, pop_table, by="lga") %>% 
    mutate(mth_rate = count/pop_2021*100000)
  
  vic_mth_rate <- filter(sti_vic_mth_rate, disease==std) %>% rename(state=lga)
  
  plot <- ggplot(nephu_mth_rate) + 
    geom_line(aes(x=mth_yr_fmt, y=mth_rate, group=disease, col="sti")) + 
    geom_line(data=vic_mth_rate, aes(x=mth_yr_fmt, y=mth_rate,  group=disease, col="sti", lty="VIC")) + 
    geom_smooth(aes(x=mth_yr_fmt, y=mth_rate, col="trend", fill="trend"), method="gam", se=T, alpha=0.7) + 
    scale_x_date(expand=c(0,0), date_breaks="3 months", date_minor_breaks="month", date_labels="%b %Y", name="") + 
    scale_y_continuous(expand=c(0,0), breaks=integer_breaks(), name="Monthly notified rate \n(per 100,000 population)") + 
    #scale_colour_manual(values=c("sti"="red", "trend"="slateblue"), labels=c("sti"=paste0(std, " (NEPHU)"), "trend"="NEPHU trend line"), name="") + 
    scale_colour_manual(values=c("sti"="red", "trend"="slateblue"), labels=c("sti"="NEPHU", "trend"="NEPHU trend and \n95% CI"), name="") + 
    scale_fill_manual(values=c("trend"="grey70"), labels=NULL, guide="none") + 
    scale_linetype_manual(values="dotted", name="", guide=guide_legend(order=1)) + 
    cowplot::theme_cowplot() + 
    theme(plot.title = element_text(size=12), 
          axis.text.x = element_text(angle = 45, hjust=1, size=9)) + 
    facet_wrap(~lga, nrow=1) + 
    labs(title=paste0("Monthly ", std, " rate per 100,000 population\n(NEPHU compared to VIC)"), 
         caption=paste0("Data period: ", start_date, " to ", max_date))
  
  return(plot)

}

#f.trend_plot_nephu("Gonorrhea")

```


``` {r lga function}
# Create function for plotting disease trends graphs (LGA level)

f.trend_plot_lga <- function(std) {
  lga_mth_count <- sti_data %>% 
    filter(disease==std) %>% 
    filter(lga %in% nephu_lgas) %>% 
    group_by(lga, mth_yr_fmt) %>% 
    summarise(count=n(), cond=first(cond), disease=first(disease))
  
  lga_mth_rate <- left_join(lga_mth_count, pop_table, by="lga") %>% 
    mutate(mth_rate = count/pop_2021*100000)
  
  vic_mth_rate <- filter(sti_vic_mth_rate, disease==std) %>% rename(state=lga)
  
  plot <- ggplot(lga_mth_rate) + 
    geom_line(aes(x=mth_yr_fmt, y=mth_rate, group=disease, col="sti")) + 
    geom_line(data=vic_mth_rate, aes(x=mth_yr_fmt, y=mth_rate,  group=disease, col="sti", lty="VIC")) + 
    geom_smooth(aes(x=mth_yr_fmt, y=mth_rate, col="trend", fill="band"), method="gam", se=T, alpha=0.7) + 
    scale_x_date(expand=c(0,0), date_breaks="3 months", date_minor_breaks="month", date_labels="%b %Y", name="") + 
    scale_y_continuous(expand=c(0,0), breaks=integer_breaks(), name="Monthly notified rate \n(per 100,000 population)") + 
    scale_colour_manual(values=c("sti"="red", "trend"="blue"), labels=c("sti"="LGA",  "trend"="LGA trend and \n95% CI"), name="") + 
    scale_fill_manual(values=c("band"="grey70"), labels=NULL, guide="none") + 
    scale_linetype_manual(values="dotted", name="", guide=guide_legend(order=1)) + 
    cowplot::theme_cowplot() + 
    theme(plot.caption = element_text(size=10), 
          axis.text.x = element_text(angle = 45, hjust=1, size=9)) + 
    facet_wrap(~lga, nrow=4, scales="free_y") + 
    labs(caption=paste0("Vertical scales vary between LGAs \nData period: ", start_date, " to ", max_date))
  
  return(plot)

}

#f.trend_plot_lga("Chlamydia")

```


```{r risk function}
sexual_exp_levels <- c("Person(s) of same sex only", "Person(s) of opposite sex only", "Person(s) of both sexes", "No sexual contact", "Other", "Unknown")
where_infect_acq_levels <- c("Victoria", "Interstate", "Overseas", "Unknown")

# sti_exp.dat <- left_join(nephu_data, exp_data, by="event_id") %>% 
#   filter(event_date>=min_date_1yr) %>% 
#   select(event_id, condition, disease, defn, sex, age, sexual_exp, lga) %>% 
#   mutate(sexual_exp = factor(sexual_exp, levels=sexual_exp_levels))

sti_exp.dat <- nephu_data %>% 
  filter(event_date>=min_date_1yr) %>% 
  select(event_id, condition, disease, defn, sex, age, sexual_orientation, lga) %>% 
  rename(sexual_exp = sexual_orientation) %>% 
  mutate(sexual_exp = factor(sexual_exp, levels=sexual_exp_levels))

cp_prt <- function(x, y) {
  paste0(x, " (", y, "%)")
}

f.sex_exp_table <- function(std) {
  table <- tabyl(sti_exp.dat %>% filter(disease==std), lga, sexual_exp) %>% 
    adorn_totals("row", fill="", na.rm=TRUE, name="NEPHU") %>% 
    select(-"NA_") %>% 
    rename(count_ss = "Person(s) of same sex only", 
           count_os = "Person(s) of opposite sex only", 
           count_bs = "Person(s) of both sexes", 
           count_oth = "Other", 
           count_unk = "Unknown") %>% 
    rowwise() %>% 
    mutate(lga_total = sum(c_across(2:6), na.rm=TRUE), # c_across(starts_with("count"))
         pct_ss = percent(count_ss/lga_total), 
         pct_os = percent(count_os/lga_total), 
         pct_bs = percent(count_bs/lga_total), 
         pct_oth = percent(count_oth/lga_total), 
         pct_unk = percent(count_unk/lga_total), 
         prt_ss = cp_prt(count_ss, pct_ss), 
         prt_os = cp_prt(count_os, pct_os), 
         prt_bs = cp_prt(count_bs, pct_bs), 
         prt_oth = cp_prt(count_oth, pct_oth), 
         prt_unk = cp_prt(count_unk, pct_unk)) %>% 
    ungroup()
  
  return(table)
}


f.exp_graph <- function(std) {
  table <- f.sex_exp_table(std) %>% 
    select(lga, pct_ss, pct_os, pct_bs) %>% 
  pivot_longer(cols=starts_with("pct_"), names_to="sexual_risk", values_to="pct") %>% 
  mutate(sexual_risk = case_when(sexual_risk=="pct_ss" ~ "Same sex", 
                                 sexual_risk=="pct_os" ~ "Opposite sex", 
                                 sexual_risk=="pct_bs" ~ "Both sex"), 
         sexual_risk = factor(sexual_risk, levels=c("Same sex", "Opposite sex", "Both sex")), 
         lga = factor(lga, levels=c(nephu_lgas, "NEPHU")))
  
  plot <- ggplot(table) + 
    geom_col(aes(x=lga, y=pct, group=sexual_risk, fill=sexual_risk), width=0.7, position=position_dodge(width=0.7), col="black") + 
    scale_x_discrete(expand=c(0,0), name="") + 
    scale_y_continuous(expand=c(0,0), breaks=integer_breaks(), name="Proportion in LGA (%)") + 
    labs(fill="main sexual \nexposure risk") + 
    cowplot::theme_cowplot() + 
    theme(plot.caption = element_text(size=10), 
          axis.text.x = element_text(angle = 45, hjust=1, size=11))
  
  return(plot)
}

# f.exp_graph("Syphilis")

f.exp_table_print <- function(table) {
  table %>% 
    select(lga, starts_with("prt_")) %>% 
    flextable(.) %>% 
    set_header_labels(lga = "LGA / NEPHU", prt_ss = "Person(s) of same sex only", prt_os = "Person(s) of opposite sex only", prt_bs = "Person(s) of both sexes", prt_oth = "Other", prt_unk = "Unknown") %>% 
    add_header_row(values=c("", "Sexual exposure risk recorded - Number of cases (%)", "", "", "", ""), top=TRUE) %>% 
    merge_at(i=1, j=2:6, part = "header") %>% 
    align(i=1, j=2:6, align="center", part="header") %>% 
    autofit() %>% 
    add_footer_lines(paste0("Data from last 12 months (", format(min_date_1yr, "%d %b %Y"), " - ", format(max_date, "%d %b %Y"), ")")) %>% 
    add_footer_lines("Data in table does not include cases with missing data for sexual exposure")
}

#f.exp_table_print(table)

```
<br>


## Chlamydia
<br>

```{r chlam_demo, eval=F}
# sex distribution
sti_data %>% filter(disease=="Chlamydia") %>% 
  filter(lga %in% nephu_lgas) %>% 
  tabyl(., cob)
sex.num <- xtabs(~sex, data=cond_data)
sex.pct <- percent(prop.table(sex.num))

# atsi distribution
atsi.num <- xtabs(~atsi, data=cond_data, addNA=TRUE)
atsi.pct <- percent(prop.table(atsi.num))
tabyl(nephu_data[nephu_data$disease=="Chlamydia", ], atsi)

# country of_birth distribution
cob.num <- xtabs(~aus_born, data=cond_data)
cob.pct <- percent(prop.table(cob.num))
tabyl(nephu_data[nephu_data$disease=="Gonorrhea", ], aus_born)

```

``` {r chlam_section1}
chlam_agesex <- f.agesex_pyr_nephu("Chlamydia")

chlam_nephu <- f.trend_plot_nephu("Chlamydia")

ggpubr::ggarrange(chlam_agesex, chlam_nephu, nrow=1)

```
<br><br>


```{r chlam_map}
f.rate_map_lga("Chlamydia")

```
<br><br>


##### Monthly Chlamydia rate per 100,000 population compared to VIC average by LGA

```{r chlam_lga_plots}
f.trend_plot_lga("Chlamydia")
```
<br><br>

```{r}
chlam_min_dftable <- f.minor_dftable("Chlamydia")

eval_chlam_minor <- if_else(length(chlam_min_dftable)>0, TRUE, FALSE)

```


```{r, eval=eval_chlam_minor}
knitr::asis_output(paste0("**Chlamydia cases in minors (<16 years) between ", format(min_date_1yr, '%d %b %Y'), " - ", format(max_date, '%d %b %Y'), "**"))

f.minor_table(chlam_min_dftable)

```
<br><br>


## Gonorrhea
<br>

```{r}
gono_agesex <- f.agesex_pyr_nephu("Gonorrhea")

gono_nephu <- f.trend_plot_nephu("Gonorrhea")

ggpubr::ggarrange(gono_agesex, gono_nephu, nrow=1)

```
<br><br>


```{r}
f.rate_map_lga("Gonorrhea")

```
<br><br>


##### Monthly Gonorrhea rate per 100,000 population compared to VIC average by LGA

```{r}
f.trend_plot_lga("Gonorrhea")
```
<br><br>

**Sexual exposure risk by LGA level**

Graph and table

```{r}
f.exp_graph("Gonorrhea")

```
<br>

```{r}
f.exp_table_print(f.sex_exp_table("Gonorrhea"))

```
<br><br>


```{r}
gono_min_dftable <- f.minor_dftable("Gonorrhea")

eval_gono_minor <- if_else(nrow(gono_min_dftable)>0, TRUE, FALSE)

```


```{r, eval=eval_gono_minor}
knitr::asis_output(paste0("**Gonorrhea cases in minors (<16 years) between ", format(min_date_1yr, '%d %b %Y'), " - ", format(max_date, '%d %b %Y'), "**"))

f.minor_table(gono_min_dftable)

```
<br><br>



## Syphilis
Syphilis here refer to both infectious syphilis and late syphilis cases as classified in PHESS.
<br>

```{r}
syph_agesex <- f.agesex_pyr_nephu("Syphilis")

syph_nephu <- f.trend_plot_nephu("Syphilis")

ggpubr::ggarrange(syph_agesex, syph_nephu, nrow=1)

```
<br><br>


```{r}
f.rate_map_lga("Syphilis")

```
<br><br>


##### Monthly Syphilis rate per 100,000 population compared to VIC average by LGA

```{r}
f.trend_plot_lga("Syphilis")
```
<br><br>

```{r}
syph_min_dftable <- f.minor_dftable("Syphilis")

eval_syph_minor <- if_else(nrow(syph_min_dftable)>0, TRUE, FALSE)

```


```{r, eval=eval_syph_minor}
knitr::asis_output(paste0("**Syphilis cases in minors (<16 years) between ", format(min_date_1yr, '%d %b %Y'), " - ", format(max_date, '%d %b %Y'), "**"))

f.minor_table(syph_min_dftable)

```
<br><br>

**Sexual exposure risk by LGA level**

Graph and table

```{r}
f.exp_graph("Syphilis")

```
<br>

```{r}
f.exp_table_print(f.sex_exp_table("Syphilis"))

```
<br><br>

**Congenital syphilis**
```{r}
syph_cong <- sti_data %>% 
  filter(condition=="Syphilis - Congenital") %>% 
  filter(lga %in% nephu_lgas) %>% 
  filter(event_date>=min_date_1yr) %>% 
  select(defn, event_date, sex, death, lga)

eval_syph_cong <- if_else(nrow(syph_cong)>0, TRUE, FALSE)
eval_syph_cong_nil <- if_else(nrow(syph_cong)==0, TRUE, FALSE)

```

```{r, eval=eval_syph_cong}
knitr::asis_output(paste0("**Congenital Syphilis cases between ", format(min_date_1yr, '%d %b %Y'), " - ", format(max_date, '%d %b %Y'), "**"))

flextable(syph_cong) %>% 
  set_header_labels(defn="Case classification", event_date = "Event date", sex="Sex", death="Death status", lga="LGA") %>% 
  autofit() %>% 
  set_caption("Data shown for the last 12 months")

```

```{r, eval=eval_syph_cong_nil}
knitr::asis_output(paste0("No reported cases of Congenital Syphilis in NEPHU between ", format(min_date_1yr, '%d %b %Y'), " - ", format(max_date, '%d %b %Y')))

```
<br><br>

## HIV

```{r hiv}
hiv_nephu <- nephu_data %>% 
  filter(disease=="HIV")

# tabyl(hiv_nephu, defn)

nephu_mth_count_hiv <- hiv_nephu %>% 
    group_by(mth_yr_fmt) %>% 
    summarise(count=n(), disease=first(disease)) %>% 
  mutate(lga="NEPHU")

vic_mth_count_hiv <- filter(sti_vic_mth_count, disease=="HIV") %>% 
  select(-lga)
  
hiv_nephu_map <- ggplot(nephu_mth_count_hiv) + 
    geom_line(aes(x=mth_yr_fmt, y=count, group=disease, col="sti")) + 
    geom_line(data=vic_mth_count_hiv, aes(x=mth_yr_fmt, y=count,  group=disease, col="sti", lty="Vic Average")) + 
    geom_smooth(aes(x=mth_yr_fmt, y=count, col="trend"), method="gam", se=F, alpha=0.7) + 
    scale_x_date(expand=c(0,0), date_breaks="3 months", date_minor_breaks="month", date_labels="%b %Y", name="") + 
    scale_y_continuous(expand=c(0,0), breaks=integer_breaks(), name="Monthly case numbers") + 
    scale_colour_manual(values=c("sti"="red", "trend"="slateblue"), labels=c("sti"="HIV", "trend"="trend line"), name="") + 
    scale_linetype_manual(values="dotted", name="") + 
    cowplot::theme_cowplot() + 
    theme(plot.title = element_text(size=12), 
          axis.text.x = element_text(angle = 45, hjust=1, size=9)) + 
    facet_wrap(~lga, nrow=1) + 
    labs(title="Monthly HIV case numbers\n(NEPHU compared to VIC)")

hiv_agesex <- f.agesex_pyr_nephu("HIV")

ggpubr::ggarrange(hiv_agesex, hiv_nephu_map, nrow=1)

```
<br><br>


```{r hiv_map}
f.rate_map_lga("HIV")

```
<br><br>

**Number of HIV cases by LGA level by year**

```{r}
hiv_counts_lga <- hiv_nephu %>% 
  group_by(lga, yr) %>% 
  summarise(count=n()) %>% 
  ungroup() %>% 
  pivot_wider(names_from = "yr", names_prefix = "Yr", values_from=count) %>% 
  replace_na(replace=list(Yr2022 = 0, Yr2023 = 0, Yr2024=0)) %>% 
  rowwise() %>% 
  #adorn_totals("col", fill="", na.rm=T, name="lga_total")
  mutate(Total = sum(c_across(starts_with("Yr")), na.rm=T))

flextable(hiv_counts_lga) %>% set_header_labels(lga="LGA") %>% autofit() %>% 
  add_footer_lines(paste0("Note: Yr", year(max_date), " is not a full year, ends ", format(max_date, '%d %b %Y'))) %>% align(i=1, j=1, align="right", part="footer")
  
```
<br><br>

**HIV cases (<18 months old)**

```{r}
hiv_cong <- nephu_data %>% 
  filter(disease=="HIV - <18mths") %>% 
  filter(event_date>=min_date_1yr) %>% 
  select(defn, event_date, sex, death, lga)

eval_hiv_cong <- if_else(nrow(hiv_cong)>0, TRUE, FALSE)
eval_hiv_cong_nil <- if_else(nrow(hiv_cong)==0, TRUE, FALSE)

```

```{r, eval=eval_hiv_cong}
knitr::asis_output(paste0("**HIV cases (<18 months old) between ", format(min_date_1yr, '%d %b %Y'), " - ", format(max_date, '%d %b %Y'), "**"))

flextable(hiv_cong) %>% 
  set_header_labels(defn="Case classification", event_date = "Event date", sex="Sex", death="Death status", lga="LGA") %>% 
  autofit() %>% 
  set_caption("Data shown for the last 12 months")

```

```{r, eval=eval_hiv_cong_nil}
knitr::asis_output(paste0("No reported cases of HIV (<18 months old) in NEPHU between ", format(min_date_1yr, '%d %b %Y'), " - ", format(max_date, '%d %b %Y')))

```

<br><br><br>
