---
title: "STI Report"
author: "Desmond Gul"
date: "Report date: `r format(Sys.Date(), '%d %b %Y')`"
output: html_document
knit: (function(input, ...) {
  rmarkdown::render(input, output_file = paste0("STI Report", "-", format(Sys.Date(), "%d %b %Y")), output_dir = "../Output") })
---


```{r setup, include=FALSE}

con <- DBI::dbConnect(odbc::odbc(), "PHAR")

knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, fig.height=6, fig.width=13, connection="con")

library(tidyverse)
library(janitor)
library(lubridate)
library(flextable)
library(DBI)
```


```{r extract_data}
sti_raw <- dbGetQuery(con, 
"
SELECT * FROM dh_public_health.phess_release.caseevents 
WHERE CONDITION_TYPE = 'Sexually Transmissible Infections' 
AND EVENT_DATE BETWEEN '2022-01-01' AND '2024-04-30' 
ORDER BY EVENT_DATE DESC; 
"
)
```

```{r set params}
max_date <- ymd("2024-04-30")
min_date_1yr <- max_date - years(1) + days(1)

```



```{r load pop_table}
pop_table <- readxl::read_xlsx(here::here("Data", "LGAPopulationData.xlsx")) %>% 
  rename(lga=LGA, 
         pop_2021 = Pop_2021)
```


``` {r gen_functions}
percent <- function (x) {round(x*100, digits=0)}

integer_breaks <- function(n = 5, ...) {
    fxn <- function(x) {
        breaks <- floor(pretty(x, n, ...))
        names(breaks) <- attr(breaks, "labels")
        breaks
    }
    return(fxn)
}

main_sti <- c("Chlamydia trachomatis infection", "Gonococcal infection", "Syphilis - Infectious", "Syphilis - Late")


# epimonth_breaks <- c(seq.Date(from=min(sti_data$mth_yr_fmt), to=max(sti_data$mth_yr_fmt) + months(1), by="month"))

```


```{r data clean}
agecat5_levels <- c("0-4", "5-9", "10-14", "15-19", "20-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54", "55-59", "60-64", "65-69", "70-74", "75-79", "80-84", "85+")

nephu_lgas <- c("Banyule (C)", "Boroondara (C)", "Darebin (C)", "Hume (C)", "Knox (C)", "Manningham (C)", "Maroondah (C)", "Nillumbik (S)", 
                    "Whitehorse (C)", "Whittlesea (C)", "Yarra (C)", "Yarra Ranges (S)")

sti_data <- sti_raw %>% 
  clean_names() %>% 
  remove_empty("cols") %>% 
  rename(defn = event_classification, 
         death = died_from_disease, 
         onset_date = calculated_date_of_onset, 
         age = age_years, 
         atsi = indigenous_status, 
         cob = country_of_birth) %>% 
  select(event_id, condition, event_date, event_type, defn, death, death_date, onset_date, 
         city, postcode, lga, lphu, age, age_months, sex, atsi, cob, assigned_lphu, 
         meets_investigation_criteria, investigation_status, case_found_by) %>% 
  filter(defn=="Confirmed" | defn=="Probable") %>% 
  filter(event_type=="Case") %>% 
  remove_empty(which="cols") %>% 
  mutate(age = if_else(age==999, NA, age)) %>% 
  mutate(agecat5 = case_when(between(age, 0, 4) ~ "0-4", 
                             between(age, 5, 9) ~ "5-9",
                             between(age, 10, 14) ~ "10-14",
                             between(age, 15, 19) ~ "15-19",
                             between(age, 20, 24) ~ "20-24",
                             between(age, 25, 29) ~ "25-29",
                             between(age, 30, 34) ~ "30-34",
                             between(age, 35, 39) ~ "35-39",
                             between(age, 40, 44) ~ "40-44",
                             between(age, 45, 49) ~ "45-49",
                             between(age, 50, 54) ~ "50-54",
                             between(age, 55, 59) ~ "55-59",
                             between(age, 60, 64) ~ "60-64",
                             between(age, 65, 69) ~ "65-69",
                             between(age, 70, 74) ~ "70-74",
                             between(age, 75, 79) ~ "75-79",
                             between(age, 80, 84) ~ "80-84",
                             between(age, 85, 99) ~ "85+", 
                             TRUE ~ NA_character_), 
         agecat5 = factor(agecat5, levels=agecat5_levels), 
         aus_born = case_when(cob=="Australia" ~ "Australia", 
                              cob=="Australia (includes External Territories), nfd" ~ "Australia", 
                              cob=="Australia External Territories, nec" ~ "Australia", 
                              cob=="Not Stated" ~ "Unknown", 
                              cob=="Unknown" ~ "Unknown", 
                              TRUE ~ "Overseas"), 
         aus_born = factor(aus_born, levels=c("Australia", "Overseas", "Unknown")), 
         defn = factor(defn, levels=c("Confirmed", "Probable")), 
         sex = factor(sex, levels=c("Female", "Male", "Not stated", "Other")), 
         atsi = fct_collapse(factor(atsi, levels=c("Aboriginal and Torres Strait Islander origin", "Aboriginal but not Torres Strait Islander origin", "Torres Strait Islander but not Aboriginal origin",  "Not Aboriginal or Torres Strait Islander", "Missing/Not Stated", "Declined to answer")), `Aboriginal and/or Torres Strait Islander` = c("Aboriginal and Torres Strait Islander origin", "Aboriginal but not Torres Strait Islander origin", "Torres Strait Islander but not Aboriginal origin")), 
         cond = case_when(condition=="Chlamydia trachomatis infection" ~ "Chlamydia", 
                          condition=="Gonococcal infection" ~ "Gonorrhea", 
                          condition=="Human Immunodeficiency Virus Infection - Child aged less than 18 months" ~ "HIV - <=18mths", 
                          condition=="Human Immunodeficiency Virus Infection - Individual aged 18 months or older" ~ "HIV - >18mths", 
                          condition=="Human Immunodeficiency Virus Infection - Not further specified" ~ "HIV - nfs", 
                          TRUE ~ condition), 
         disease = case_when(condition=="Chlamydia trachomatis infection" ~ "Chlamydia", 
                          condition=="Gonococcal infection" ~ "Gonorrhea", 
                          condition=="Human Immunodeficiency Virus Infection - Child aged less than 18 months" ~ "HIV - <=18mths", 
                          condition=="Human Immunodeficiency Virus Infection - Individual aged 18 months or older" ~ "HIV", 
                          condition=="Human Immunodeficiency Virus Infection - Not further specified" ~ "HIV", 
                          condition=="Syphilis - Infectious" ~ "Syphilis", 
                          condition=="Syphilis - Late" ~ "Syphilis", 
                          TRUE ~ condition), 
         event_date = ymd(event_date), 
         epiweek = epiweek(event_date), 
         epimonth = month(event_date, label=TRUE), 
         epiyear = epiyear(event_date), 
         epi_MY = my(paste(epimonth, epiyear, sep="-")), 
         epi_Y = ymd(paste0(epiyear, "-01-01")), 
         epi_WY = ceiling_date(event_date, "week") -1, 
         mth_yr_fmt = my(paste(month(event_date, label=TRUE), year(event_date))), 
         mth_yr = paste(epimonth, year(event_date))) %>% 
  arrange(event_date)

#tabyl(sti_data, condition, cond)
#tabyl(sti_data, cond)

nephu_data <- filter(sti_data, lga %in% nephu_lgas)
  
```


### Disease Profiles

Each disease profile will include:

* Disease trends - 1 Jan 2022 to present date (NEPHU and by LGA vs VIC)

* Age and sex distribution of cases

* Map showing annual rate per 100,000 at LGA level

* Sexual exposure risk for Gonorrhoea and Syphilis (NEPHU and by LGA)


```{r minors}
minor <- sti_data %>% 
  filter(age<16) %>% 
  filter(lga %in% nephu_lgas)


f.minor_dftable <- function(std) {
  table <- minor %>% 
    filter(disease==std) %>% 
    filter(event_date>=min_date_1yr) %>% 
    group_by(lga) %>% 
    summarise(total = n(), 
              females = sum(sex=="Female", na.rm=T), 
              pct_females = percent(females / total), 
              median_age = median(age, na.rm=T))
  return(table)
}

f.minor_table <- function(df) {
  flextable(df) %>% 
    autofit() %>% 
    set_header_labels(lga = "LGA", total = "Total", females = "Females", pct_females = "% Females", median_age = "Median age") %>% 
    set_caption("Data shown for the last 12 months")

}

#f.minor_table(f.minor_dftable("Gonorrhea"))

```


``` {r age-sex pyramid_function}
f.agesex_pyr_nephu <- function(std) {
  pyramid.dat <- sti_data %>% 
    filter(disease==std) %>% 
    filter(lga %in% nephu_lgas) %>% 
    select(age, agecat5, sex, defn, cond, condition) %>% 
    filter(sex %in% c("Male", "Female")) %>% 
    mutate(sex=fct_rev(fct_drop(sex)))
  
  plot <- apyramid::age_pyramid(data=pyramid.dat, age_group="agecat5", split_by="sex", stack_by="disease", show_midpoint=FALSE, pal=c("#F8766D", "#00BFC4")) + 
  cowplot::theme_cowplot() + 
  theme(plot.title = element_text(size=12), 
        legend.position="none") + 
  labs(y="cases", x="age group (years)", title=paste0("Age and sex distribution of\n", std, " cases in NEPHU"))
  
  return(plot)
}

#f.agesex_pyr_nephu("Chlamydia")

```

```{r vic rates}

sti_vic_mth_count <- sti_data %>% 
  #filter(condition %in% main_sti) %>% 
  group_by(mth_yr_fmt, disease) %>% 
  summarise(count = n(), cond = first(cond)) %>% 
  mutate(lga = "VIC")

sti_vic_mth_rate <- sti_vic_mth_count %>% 
  left_join(., pop_table, by="lga") %>% 
  mutate(mth_rate = count/pop_2021*100000)

```
``` {r nephu base map}
library(sf)
map_folder <- "C:/Users/gulzdz/OneDrive - Austin Health/Epidemiology/Epi reports/CD Surveillance Reporting Rmarkdown/Data"
map_file <- "LGA_2022_AUST_GDA2020_SHP/LGA_2022_AUST_GDA2020.shp"

nephu_lgas_short <- c("Banyule", "Boroondara", "Darebin", "Hume", "Knox", "Manningham", "Maroondah", "Nillumbik", "Whitehorse", "Whittlesea", "Yarra", "Yarra Ranges")

nephu_lga.sf <- st_read(file.path(map_folder, map_file), quiet=TRUE) %>% 
  select(-c(STE_CODE21, AUS_CODE21, AUS_NAME21, LOCI_URI21)) %>% 
  rename(lga_code=LGA_CODE22, lga_name=LGA_NAME22, ste_name=STE_NAME21, areasqkm=AREASQKM, shp_length=SHAPE_Leng, 
         shp_area=SHAPE_Area) %>% 
  filter(lga_name %in% nephu_lgas_short) %>% 
  arrange(lga_name) 
nephu_lga.sf$LGA <- nephu_lgas

```

``` {r map_function}
nudge_lga <- c("Boroondara", "Darebin", "Yarra", "Maroondah")

f.rate_map_lga <- function(std) {
  data <- sti_data %>% 
    filter(disease==std) %>% 
    filter(lga %in% nephu_lgas) %>% 
    filter(event_date>=min_date_1yr) %>% 
    group_by(lga) %>% 
    summarise(count=n()) %>% 
    left_join(., pop_table, by="lga") %>% 
    mutate(rate = count/pop_2021*100000)
  
  map <- left_join(nephu_lga.sf, data, by=c("LGA"="lga")) %>% 
    ggplot() + 
    geom_sf(aes(fill=rate), col="black") + 
    scale_fill_gradient2(low="yellow", high="red", name = "Rate") + 
    geom_sf_text(data=nephu_lga.sf %>% filter(!(lga_name %in% nudge_lga)), aes(label=lga_name), size=3) + 
    geom_sf_text(data=nephu_lga.sf %>% filter(lga_name=="Darebin"), aes(label=lga_name), size=3, nudge_x = -0.07, nudge_y= -0.01) + 
    geom_sf_text(data=nephu_lga.sf %>% filter(lga_name=="Yarra"), aes(label=lga_name), size=3, nudge_x = -0.03, nudge_y= -0.01) + 
    geom_sf_text(data=nephu_lga.sf %>% filter(lga_name=="Boroondara"), aes(label=lga_name), size=3, nudge_x = -0.07, nudge_y= -0.025) + 
    geom_sf_text(data=nephu_lga.sf %>% filter(lga_name=="Maroondah"), aes(label=lga_name), size=3, nudge_x = 0.03, nudge_y= -0.01) + 
    theme_void() + 
    labs(title = paste0("Map showing LGA distribution of ", std, " case rate in last 12 months"), 
         subtitle="Annual rate per 100,000 population") + 
    theme(plot.title = element_text(size=12), 
          plot.subtitle = element_text(size=11))
  
  return(map)
  
}

#f.rate_map_lga("Gonorrhea")

```


``` {r nephu function}
# Create function for plotting disease trends graphs (NEPHU level)

f.trend_plot_nephu <- function(std) {
  nephu_mth_count <- sti_data %>% 
    filter(disease==std) %>% 
    filter(lga %in% nephu_lgas) %>% 
    group_by(mth_yr_fmt) %>% 
    summarise(count=n(), cond=first(cond), disease=first(disease)) %>% 
    mutate(lga="NEPHU")
  
  nephu_mth_rate <- left_join(nephu_mth_count, pop_table, by="lga") %>% 
    mutate(mth_rate = count/pop_2021*100000)
  
  vic_mth_rate <- filter(sti_vic_mth_rate, disease==std) %>% rename(state=lga)
  
  plot <- ggplot(nephu_mth_rate) + 
    geom_line(aes(x=mth_yr_fmt, y=mth_rate, group=disease, col="sti")) + 
    geom_line(data=vic_mth_rate, aes(x=mth_yr_fmt, y=mth_rate,  group=disease, col="sti", lty="Vic Average")) + 
    geom_smooth(aes(x=mth_yr_fmt, y=mth_rate, col="trend"), method="gam", se=F, alpha=0.7) + 
    scale_x_date(expand=c(0,0), date_breaks="3 months", date_minor_breaks="month", date_labels="%b %Y", name="") + 
    scale_y_continuous(expand=c(0,0), breaks=integer_breaks(), name="Monthly notified rate \n(per 100,000 population)") + 
    scale_colour_manual(values=c("sti"="red", "trend"="slateblue"), labels=c("sti"=std, "trend"="trend line"), name="") + 
    scale_linetype_manual(values="dotted", name="") + 
    cowplot::theme_cowplot() + 
    theme(plot.title = element_text(size=12), 
          axis.text.x = element_text(angle = 45, hjust=1, size=9)) + 
    facet_wrap(~lga, nrow=1) + 
    labs(title=paste0(std, " rate per 100,000 population\n(NEPHU compared to VIC)"))
  
  return(plot)

}

#f.trend_plot_nephu("Gonorrhea")

```


``` {r lga function}
# Create function for plotting disease trends graphs (LGA level)

f.trend_plot_lga <- function(std) {
  lga_mth_count <- sti_data %>% 
    filter(disease==std) %>% 
    filter(lga %in% nephu_lgas) %>% 
    group_by(lga, mth_yr_fmt) %>% 
    summarise(count=n(), cond=first(cond), disease=first(disease))
  
  lga_mth_rate <- left_join(lga_mth_count, pop_table, by="lga") %>% 
    mutate(mth_rate = count/pop_2021*100000)
  
  vic_mth_rate <- filter(sti_vic_mth_rate, disease==std) %>% rename(state=lga)
  
  plot <- ggplot(lga_mth_rate) + 
    geom_line(aes(x=mth_yr_fmt, y=mth_rate, group=disease, col="sti")) + 
    geom_line(data=vic_mth_rate, aes(x=mth_yr_fmt, y=mth_rate,  group=disease, col="sti", lty="Vic Average")) + 
    geom_smooth(aes(x=mth_yr_fmt, y=mth_rate, col="trend"), method="gam", se=F, alpha=0.7) + 
    scale_x_date(expand=c(0,0), date_breaks="3 months", date_minor_breaks="month", date_labels="%b %Y", name="") + 
    scale_y_continuous(expand=c(0,0), breaks=integer_breaks(), name="Monthly notified rate \n(per 100,000 population)") + 
    scale_colour_manual(values=c("sti"="red", "trend"="blue"), labels=c("sti"=std, "trend"="trend line"), name="") + 
    scale_linetype_manual(values="dotted", name="") + 
    cowplot::theme_cowplot() + 
    theme(plot.caption = element_text(size=10), 
          axis.text.x = element_text(angle = 45, hjust=1, size=9)) + 
    facet_wrap(~lga, nrow=4, scales="free_y") + 
    labs(caption="Vertical scales vary between LGAs")
  
  return(plot)

}

#f.trend_plot_lga("Chlamydia")

```

## Chlamydia
<br>

```{r chlam_demo, eval=F}
# sex distribution
sti_data %>% filter(disease=="Chlamydia") %>% 
  filter(lga %in% nephu_lgas) %>% 
  tabyl(., cob)
sex.num <- xtabs(~sex, data=cond_data)
sex.pct <- percent(prop.table(sex.num))

# atsi distribution
atsi.num <- xtabs(~atsi, data=cond_data, addNA=TRUE)
atsi.pct <- percent(prop.table(atsi.num))
tabyl(nephu_data[nephu_data$disease=="Chlamydia", ], atsi)

# country of_birth distribution
cob.num <- xtabs(~aus_born, data=cond_data)
cob.pct <- percent(prop.table(cob.num))
tabyl(nephu_data[nephu_data$disease=="Gonorrhea", ], aus_born)

```

``` {r chlam_section1}
chlam_agesex <- f.agesex_pyr_nephu("Chlamydia")

chlam_nephu <- f.trend_plot_nephu("Chlamydia")

ggpubr::ggarrange(chlam_agesex, chlam_nephu, nrow=1)

```
<br><br>


```{r}
f.rate_map_lga("Chlamydia")

```
<br><br>


##### Monthly Chlamydia rate per 100,000 population compared to VIC average by LGA

```{r}
f.trend_plot_lga("Chlamydia")
```
<br><br>

```{r}
chlam_min_dftable <- f.minor_dftable("Chlamydia")

eval_chlam_minor <- if_else(length(chlam_min_dftable)>0, TRUE, FALSE)

```


```{r, eval=eval_chlam_minor}
knitr::asis_output(paste0("**Chlamydia cases in minors (<16 years) between ", eval(min_date_1yr), " - ", eval(max_date), "**"))

f.minor_table(chlam_min_dftable)

```
<br><br>


## Gonorrhea
<br>

```{r}
gono_agesex <- f.agesex_pyr_nephu("Gonorrhea")

gono_nephu <- f.trend_plot_nephu("Gonorrhea")

ggpubr::ggarrange(gono_agesex, gono_nephu, nrow=1)

```
<br><br>


```{r}
f.rate_map_lga("Gonorrhea")

```
<br><br>


##### Monthly Gonorrhea rate per 100,000 population compared to VIC average by LGA

```{r}
f.trend_plot_lga("Gonorrhea")
```
<br><br>

```{r}
gono_min_dftable <- f.minor_dftable("Gonorrhea")

eval_gono_minor <- if_else(length(gono_min_dftable)>0, TRUE, FALSE)

```


```{r, eval=eval_gono_minor}
knitr::asis_output(paste0("**Gonorrhea cases in minors (<16 years) between ", eval(min_date_1yr), " - ", eval(max_date), "**"))

f.minor_table(gono_min_dftable)

```
<br><br>



## Syphilis
Syphilis here refer to both infectious syphilis and late syphilis cases as classified in PHESS.
<br>

```{r}
syph_agesex <- f.agesex_pyr_nephu("Syphilis")

syph_nephu <- f.trend_plot_nephu("Syphilis")

ggpubr::ggarrange(syph_agesex, syph_nephu, nrow=1)

```
<br><br>


```{r}
f.rate_map_lga("Syphilis")

```
<br><br>


##### Monthly Syphilis rate per 100,000 population compared to VIC average by LGA

```{r}
f.trend_plot_lga("Syphilis")
```
<br><br>

```{r}
syph_min_dftable <- f.minor_dftable("Syphilis")

eval_syph_minor <- if_else(length(syph_min_dftable)>0, TRUE, FALSE)

```


```{r, eval=eval_syph_minor}
knitr::asis_output(paste0("**Syphilis cases in minors (<16 years) between ", eval(min_date_1yr), " - ", eval(max_date), "**"))

f.minor_table(syph_min_dftable)

```
<br><br>

```{r}
syph_cong <- sti_data %>% 
  filter(condition=="Syphilis - Congenital") %>% 
  filter(lga %in% nephu_lgas) %>% 
  filter(event_date>=min_date_1yr) %>% 
  select(defn, event_date, sex, death, lga)

eval_syph_cong <- if_else(length(syph_cong)>0, TRUE, FALSE)
eval_syph_cong_nil <- if_else(length(syph_cong)==0, TRUE, FALSE)

```

```{r, eval=eval_syph_cong}
knitr::asis_output(paste0("**Congenital Syphilis cases between ", eval(min_date_1yr), " - ", eval(max_date), "**"))

flextable(syph_cong) %>% 
  set_header_labels(defn="Case classification", event_date = "Event date", sex="Sex", death="Death status", lga="LGA") %>% 
  autofit() %>% 
  set_caption("Data shown for the last 12 months")

```

```{r, eval=eval_syph_cong_nil}
knitr::asis_output(paste0("No reported cases of Congenital Syphilis in NEPHU between ", eval(min_date_1yr), " - ", eval(max_date)))

```


<br><br><br>
